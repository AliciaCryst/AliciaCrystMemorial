<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBy6Il_3UJsCkyR7TFwGcVn12eONTy7v_g",
    authDomain: "aliciacrystmemorial.firebaseapp.com",
    projectId: "aliciacrystmemorial",
    storageBucket: "aliciacrystmemorial.firebasestorage.app",
    messagingSenderId: "258617426442",
    appId: "1:258617426442:web:ec7e31541f311049e855f3",
    measurementId: "G-NQZ441QWE5"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  let adminMode = false;

  function activateAdmin() {
    const pass = prompt("Enter admin passphrase:");
    if (pass === "EternalAlicia95135!") {
      adminMode = true;
      loadStories();
    } else {
      alert("Incorrect passphrase.");
    }
  }

  function submitStory() {
    const text = document.getElementById("storyInput").value.trim();
    if (!text) {
      document.getElementById("confirmation").innerText = "⚠️ Please write something first.";
      return;
    }
    db.collection("stories").add({
      text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      document.getElementById("confirmation").innerText = "✅ Your story has been shared.";
      document.getElementById("storyInput").value = "";
    }).catch((error) => {
      document.getElementById("confirmation").innerText = "❌ Error: " + error.message;
    });
  }

  function deleteStory(id) {
    if (!adminMode || !confirm("Delete this story?")) return;
    db.collection("stories").doc(id).delete();
  }

  function updateStory(id, newText) {
    db.collection("stories").doc(id).update({ text: newText });
  }

  function loadStories() {
    db.collection("stories").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      const list = document.getElementById("storyList");
      list.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const storyDiv = document.createElement("div");
        storyDiv.className = "story fade-in-entry";

        const p = document.createElement("p");
        p.textContent = data.text;
        storyDiv.appendChild(p);

        // Add timestamp
        if (data.timestamp && data.timestamp.toDate) {
          const ts = data.timestamp.toDate().toLocaleString();
          const stamp = document.createElement("div");
          stamp.style.fontSize = "0.8em";
          stamp.style.color = "#aaa";
          stamp.style.marginTop = "0.3em";
          stamp.textContent = `🕓 Shared on ${ts}`;
          storyDiv.appendChild(stamp);
        }

        if (adminMode) {
          const editBtn = document.createElement("button");
          editBtn.textContent = "✏️ Edit";
          editBtn.style.marginLeft = "0.5em";
          editBtn.onclick = () => {
            const textarea = document.createElement("textarea");
            textarea.value = data.text;
            const saveBtn = document.createElement("button");
            saveBtn.textContent = "✅ Save";
            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "❌ Cancel";

            storyDiv.innerHTML = "";
            storyDiv.appendChild(textarea);
            storyDiv.appendChild(saveBtn);
            storyDiv.appendChild(cancelBtn);

            saveBtn.onclick = () => {
              const newText = textarea.value.trim();
              if (newText) updateStory(doc.id, newText);
            };
            cancelBtn.onclick = loadStories;
          };

          const delBtn = document.createElement("button");
          delBtn.textContent = "🗑️ Delete";
          delBtn.style.marginLeft = "0.5em";
          delBtn.onclick = () => deleteStory(doc.id);

          storyDiv.appendChild(editBtn);
          storyDiv.appendChild(delBtn);
        }

        list.appendChild(storyDiv);
      });
    });
  }

  window.addEventListener("DOMContentLoaded", loadStories);
</script>
